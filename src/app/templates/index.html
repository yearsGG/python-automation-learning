<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘ç»œè®¾å¤‡è‡ªåŠ¨åŒ–è¿ç»´å¹³å°</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 10px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; padding: 15px 20px; font-weight: bold; border-radius: 10px 10px 0 0 !important; }
        .status-badge { font-size: 0.9em; padding: 5px 10px; }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex align-items-center mb-4">
            <h2 class="me-auto">ğŸš€ ç½‘ç»œè®¾å¤‡è‡ªåŠ¨åŒ–è¿ç»´å¹³å°</h2>
            <span class="badge bg-secondary">æ¯•ä¸šè®¾è®¡ v1.0</span>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan-pane" type="button" role="tab">
                    âš¡ å®æ—¶å·¡æ£€
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button" role="tab" onclick="loadHistory()">
                    ğŸ“œ å†å²è®°å½•
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="scan-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header text-primary">
                        è®¾å¤‡: AR1000v (192.168.10.1)
                    </div>
                    <div class="card-body">
                        <button id="btn-scan" class="btn btn-primary" onclick="startScan()">
                            <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            å¼€å§‹æ¥å£å·¡æ£€
                        </button>
                        <span id="status-text" class="ms-3 text-muted">ç‚¹å‡»æŒ‰é’®å¼€å§‹é‡‡é›†æ•°æ®...</span>

                        <div class="mt-4 table-responsive">
                            <table class="table table-hover align-middle" id="result-table" style="display:none;">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ¥å£åç§°</th>
                                        <th>IP åœ°å€</th>
                                        <th>ç‰©ç†çŠ¶æ€</th>
                                        <th>åè®®çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="history-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header text-secondary">
                        æœ€è¿‘å·¡æ£€è®°å½• (æ•°æ®åº“: netops.db)
                    </div>
                    <div class="card-body">
                        <button class="btn btn-sm btn-outline-secondary mb-3" onclick="loadHistory()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æ—¶é—´</th>
                                        <th>è®¾å¤‡ IP</th>
                                        <th>æ‰§è¡Œå‘½ä»¤</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- åŠŸèƒ½ 1: å®æ—¶å·¡æ£€ ---
        function startScan() {
            const btn = document.getElementById('btn-scan');
            const spinner = document.getElementById('spinner');
            const status = document.getElementById('status-text');
            const table = document.getElementById('result-table');
            const tbody = document.getElementById('table-body');

            // é”å®šæŒ‰é’® UI
            btn.disabled = true;
            spinner.classList.remove('d-none');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ­£åœ¨å·¡æ£€ä¸­...';
            status.innerText = "æ­£åœ¨è¿æ¥è®¾å¤‡å¹¶é‡‡é›†æ•°æ®ï¼Œè¯·ç¨å€™...";
            tbody.innerHTML = "";
            table.style.display = 'none';

            // è¯·æ±‚åç«¯ API
            fetch('/api/scan/interfaces')
                .then(response => response.json())
                .then(res => {
                    if (res.status === 'success') {
                        // æ¸²æŸ“è¡¨æ ¼
                        res.data.forEach(row => {
                            const tr = document.createElement('tr');
                            // ç®€å•çš„çŠ¶æ€é¢œè‰²åˆ¤æ–­
                            const phyClass = row.physical && row.physical.toLowerCase().includes('up') ? 'text-success fw-bold' : 'text-danger';
                            
                            tr.innerHTML = `
                                <td>${row.interface || '-'}</td>
                                <td>${row.ip_address || '-'}</td>
                                <td class="${phyClass}">${row.physical || '-'}</td>
                                <td>${row.protocol || '-'}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                        table.style.display = 'table';
                        status.innerHTML = `<span class="text-success">âœ… å·¡æ£€å®Œæˆ! å…±å‘ç° ${res.data.length} ä¸ªæ¥å£</span>`;
                    } else {
                        alert("å·¡æ£€å¤±è´¥: " + res.message);
                        status.innerHTML = `<span class="text-danger">âŒ å‘ç”Ÿé”™è¯¯: ${res.message}</span>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                    status.innerText = "ç½‘ç»œè¯·æ±‚å¤±è´¥";
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®
                    btn.disabled = false;
                    btn.innerHTML = 'å¼€å§‹æ¥å£å·¡æ£€';
                });
        }

        // --- åŠŸèƒ½ 2: åŠ è½½å†å²è®°å½• ---
        function loadHistory() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>';

            fetch('/api/history')
                .then(response => response.json())
                .then(res => {
                    tbody.innerHTML = ""; // æ¸…ç©º
                    if (res.data && res.data.length > 0) {
                        res.data.forEach(log => {
                            const tr = document.createElement('tr');
                            const statusBadge = log.status === 'success' 
                                ? '<span class="badge bg-success">æˆåŠŸ</span>' 
                                : '<span class="badge bg-danger">å¤±è´¥</span>';
                            
                            tr.innerHTML = `
                                <td>${log.id}</td>
                                <td>${log.timestamp}</td>
                                <td>${log.device_ip}</td>
                                <td><code>${log.command}</code></td>
                                <td>${statusBadge}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— å†å²è®°å½•</td></tr>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
                });
        }
    </script>
</body>
</html>