# 网络自动化巡检项目 - 实验拓扑设计方案

> **项目名称**: Python网络设备自动化巡检平台  
> **拓扑目标**: 模拟真实企业网络环境，支持自动化巡检功能测试  
> **推荐模拟器**: 华为eNSP / EVE-NG / GNS3

---

## 📋 目录

1. [拓扑方案概览](#拓扑方案概览)
2. [方案一：小型企业网络（推荐入门）](#方案一小型企业网络)
3. [方案二：中型园区网络（进阶）](#方案二中型园区网络)
4. [方案三：多站点企业网络（高级）](#方案三多站点企业网络)
5. [设备配置清单](#设备配置清单)
6. [自动化测试场景](#自动化测试场景)

---

## 🎯 拓扑方案概览

### 设计原则
1. **层次化架构**: 核心层、汇聚层、接入层清晰分离
2. **冗余性**: 关键链路双备份，测试高可用协议
3. **协议多样性**: 涵盖OSPF、BGP、VRRP等关键协议
4. **易于扩展**: 可根据学习进度逐步增加设备

### 三种方案对比

| 方案 | 设备数量 | 复杂度 | 适用阶段 | 资源需求 |
|------|---------|-------|---------|---------|
| 方案一 | 6-8台 | ⭐⭐ | 入门/快速验证 | 4GB内存 |
| 方案二 | 12-15台 | ⭐⭐⭐⭐ | 进阶/完整测试 | 8GB内存 |
| 方案三 | 20+台 | ⭐⭐⭐⭐⭐ | 高级/生产模拟 | 16GB内存 |

---

## 方案一：小型企业网络（推荐入门）

### 拓扑架构图

```
                   Internet
                      |
                 [R-WAN1]  (边界路由器)
                      |
            +--------[SW-Core1]--------+  (核心交换机)
            |                          |
       [SW-Access1]              [SW-Access2]  (接入交换机)
            |                          |
      [PC1] [PC2]                [Server1] [Server2]
```

### 设备清单

| 序号 | 设备名称 | 设备类型 | IP地址 | 用途 |
|------|---------|---------|--------|------|
| 1 | R-WAN1 | 路由器 (AR2220) | 10.0.0.1/24 (Mgmt) | 边界路由，运行BGP |
| 2 | SW-Core1 | 核心交换机 (S5700) | 10.0.0.10/24 | 核心交换，运行OSPF |
| 3 | SW-Access1 | 接入交换机 (S3700) | 10.0.0.20/24 | 接入层 |
| 4 | SW-Access2 | 接入交换机 (S3700) | 10.0.0.21/24 | 接入层 |
| 5 | Server1 | Linux服务器 | 192.168.10.100/24 | 巡检服务器（运行Python脚本） |

### 协议配置

**1. 管理网络**
- 所有设备配置单独的管理VLAN (VLAN 99)
- 管理网段：10.0.0.0/24
- 启用SSH服务（用于自动化连接）

**2. 路由协议**
- 核心层运行OSPF（Area 0）
- 边界路由器运行BGP（与ISP对接）

**3. 高可用**
- 核心交换机配置VRRP（虚拟IP）
- 接入层使用MSTP防环

### eNSP配置示例

#### R-WAN1 (边界路由器)
```
sys
sysname R-WAN1

# 配置管理接口
interface GigabitEthernet0/0/0
 ip address 10.0.0.1 255.255.255.0
 description Management

# 启用SSH
user-interface vty 0 4
 authentication-mode aaa
 protocol inbound ssh

aaa
 local-user netconftest password cipher huaweiDC
 local-user netconftest privilege level 15
 local-user netconftest service-type ssh

ssh user netconftest authentication-type password
ssh user netconftest service-type stelnet

stelnet server enable

# 启用SNMP
snmp-agent
snmp-agent sys-info version v2c
snmp-agent community read public
```

#### SW-Core1 (核心交换机)
```
sys
sysname SW-Core1

# 管理VLAN
vlan 99
 description Management

interface Vlanif99
 ip address 10.0.0.10 255.255.255.0

# 业务VLAN
vlan batch 10 20 30

interface Vlanif10
 description Server-VLAN
 ip address 192.168.10.1 255.255.255.0

# OSPF配置
ospf 1 router-id 10.0.0.10
 area 0.0.0.0
  network 10.0.0.0 0.0.0.255
  network 192.168.10.0 0.0.0.255

# 启用SSH（同R-WAN1配置）
# 启用SNMP（同R-WAN1配置）
```

### 巡检脚本测试场景

**场景1：基础连通性检测**
```python
devices = [
    {'host': '10.0.0.1', 'name': 'R-WAN1'},
    {'host': '10.0.0.10', 'name': 'SW-Core1'},
    {'host': '10.0.0.20', 'name': 'SW-Access1'},
]

# 测试Ping
for device in devices:
    result = ping(device['host'])
    print(f"{device['name']}: {'在线' if result else '离线'}")
```

**场景2：设备信息采集**
- `display version` - 系统版本
- `display cpu-usage` - CPU使用率
- `display memory-usage` - 内存使用率
- `display interface brief` - 接口状态

**场景3：SNMP采集**
- CPU: OID `.1.3.6.1.4.1.2011.5.25.31.1.1.1.1.5`
- 内存: OID `.1.3.6.1.4.1.2011.6.1.2.1.1.2`

---

## 方案二：中型园区网络（进阶）

### 拓扑架构图

```
                        Internet
                           |
                   +------[FW1]------+  (防火墙)
                   |                 |
              [R-WAN1]           [R-WAN2]  (边界路由器冗余)
                   |                 |
         +---------+-----------------+---------+
         |                                     |
    [SW-Core1]------VRRP/堆叠------[SW-Core2]  (核心层)
         |                                 |
    +----+----+                       +----+----+
    |         |                       |         |
[SW-Agg1] [SW-Agg2]             [SW-Agg3] [SW-Agg4]  (汇聚层)
    |         |                       |         |
[SW-Acc1][SW-Acc2]               [SW-Acc3][SW-Acc4]  (接入层)
    |         |                       |         |
  Clients  Clients                 Servers   Servers
```

### 设备清单（15台设备）

| 层级 | 设备名称 | 数量 | 型号建议 | 主要协议 |
|------|---------|------|---------|---------|
| 边界 | R-WAN1/2 | 2 | AR2220 | BGP, OSPF |
| 核心 | SW-Core1/2 | 2 | S5700 | OSPF, VRRP, MSTP |
| 汇聚 | SW-Agg1/2/3/4 | 4 | S5700 | OSPF, VLAN |
| 接入 | SW-Acc1/2/3/4 | 4 | S3700 | VLAN, STP |
| 安全 | FW1 | 1 | USG6000 | NAT, ACL |
| 服务器 | Server1 | 1 | Linux | 运行巡检脚本 |

**总计**: 13台网络设备 + 1台服务器 + 若干PC

### IP地址规划

| 网段 | 用途 | VLAN | 网关 |
|------|------|------|------|
| 10.0.0.0/24 | 设备管理 | 99 | 10.0.0.1 |
| 172.16.1.0/24 | 核心互联 | - | - |
| 192.168.10.0/24 | 服务器网段 | 10 | 192.168.10.1 |
| 192.168.20.0/24 | 办公网段1 | 20 | 192.168.20.1 |
| 192.168.30.0/24 | 办公网段2 | 30 | 192.168.30.1 |

### 协议配置要点

**1. OSPF多区域**
```
- Area 0: 核心层
- Area 1: 汇聚层+接入层
- 在汇聚层做路由汇总
```

**2. VRRP高可用**
```
SW-Core1和SW-Core2配置VRRP
虚拟IP: 192.168.10.254 (作为服务器网关)
```

**3. MSTP生成树**
```
实例1: VLAN 10, 20 (SW-Core1为根)
实例2: VLAN 30, 40 (SW-Core2为根)
```

### 自动化测试场景

**场景1：批量设备巡检**
- 并发连接15台设备
- 采集CPU/内存/接口状态
- 生成Excel报告

**场景2：OSPF邻居检测**
```python
# 执行命令
output = ssh.execute(b"display ospf peer brief")

# 解析邻居状态
neighbors = parse_ospf_neighbors(output)

# 告警检测
for nbr in neighbors:
    if nbr['state'] != 'Full':
        send_alert(f"OSPF邻居异常: {nbr['neighbor_id']}")
```

**场景3：VRRP状态监控**
- 检测VRRP Master/Backup状态
- 模拟故障切换
- 验证自动化脚本能否检测到状态变化

**场景4：流量监控**
- 通过SNMP采集接口流量
- 绘制流量趋势图（使用matplotlib）
- 超阈值告警

---

## 方案三：多站点企业网络（高级）

### 拓扑架构图

```
                         Internet
                             |
                    +-------[ISP]-------+
                    |                   |
               [总部数据中心]        [分支机构1]
                    |                   |
            [双核心+双出口]          [单路由器]
                    |                   |
          [汇聚层/接入层]            [接入交换机]
                    |                   |
            [DMZ区/办公区]           [办公PC]
                    
                  MPLS VPN / IPsec VPN 连接
```

### 设备清单（20+台设备）

**总部（15台）**
- 边界路由器: 2台
- 核心交换机: 2台
- 汇聚交换机: 4台
- 接入交换机: 6台
- 防火墙: 1台

**分支机构（5台）**
- 边界路由器: 1台
- 核心交换机: 1台
- 接入交换机: 3台

### 新增协议/技术

1. **BGP路由**
   - 总部与ISP建立eBGP
   - 总部与分支建立iBGP

2. **VPN技术**
   - IPsec VPN（总部-分支）
   - GRE Tunnel + IPsec

3. **QoS**
   - 语音流量优先级
   - 流量整形

4. **安全策略**
   - ACL访问控制
   - 防火墙规则

### 高级巡检场景

**场景1：多站点统一巡检**
```python
# 配置文件：sites.ini
[headquarters]
devices = R-WAN1, R-WAN2, SW-Core1, SW-Core2, ...

[branch_office1]
devices = R-Branch1, SW-Branch1, ...

# 脚本按站点分组巡检
for site in sites:
    report = inspect_site(site)
    send_report_to(site.manager_email, report)
```

**场景2：VPN隧道监控**
- 检测IPsec隧道状态
- 测试隧道延迟和丢包率
- 自动重启故障隧道

**场景3：BGP路由监控**
- 检测BGP邻居状态
- 分析路由表变化
- 告警路由震荡

**场景4：网络拓扑自动发现**
- 通过LLDP协议发现所有设备
- 使用NetworkX构建拓扑图
- 生成交互式Web拓扑图

---

## 🛠️ 设备配置清单（通用）

### 所有设备必须配置

1. **SSH服务启用**
```
user-interface vty 0 4
 authentication-mode aaa
 protocol inbound ssh

aaa
 local-user netconftest password cipher huaweiDC
 local-user netconftest privilege level 15
 local-user netconftest service-type ssh

ssh user netconftest authentication-type password
stelnet server enable
```

2. **SNMP配置**
```
snmp-agent
snmp-agent sys-info version v2c v3
snmp-agent community read public
snmp-agent community write private
snmp-agent sys-info contact admin@example.com
snmp-agent sys-info location DataCenter-Floor3
```

3. **管理接口**
```
interface Vlanif99
 description Management
 ip address 10.0.0.X 255.255.255.0
```

4. **日志服务器（可选）**
```
info-center enable
info-center loghost 10.0.0.100
```

### 推荐的设备命名规范

```
[站点代码]-[设备类型][楼层]-[序号]

例如：
HQ-R-WAN1  (总部-路由器-WAN-1号)
HQ-SW-C1   (总部-交换机-Core-1号)
HQ-SW-A2F3 (总部-交换机-Access-2号楼3层)
BR1-R1     (分支1-路由器-1号)
```

---

## 🧪 自动化测试场景设计

### 测试场景1：设备可达性检测

**目标**: 验证所有设备在线且可管理

**测试步骤**:
```python
# 1. 从配置文件读取设备列表
devices = load_devices_from_config()

# 2. 批量Ping测试
results = {}
for device in devices:
    is_reachable = ping(device['ip'], timeout=3)
    results[device['name']] = is_reachable

# 3. 生成报告
generate_reachability_report(results)

# 4. 告警不可达设备
unreachable = [d for d, status in results.items() if not status]
if unreachable:
    send_alert(f"设备离线: {', '.join(unreachable)}")
```

**预期结果**: 所有设备Ping通，报告显示100%可用率

---

### 测试场景2：设备性能采集

**目标**: 采集CPU、内存、接口状态

**测试步骤**:
```python
from my_visual_ssh import VisualSSH

def collect_device_info(host, username, password):
    ssh = VisualSSH(host, username=username, password=password)
    ssh.read_until(b'>')
    ssh.write(b'system-view')
    ssh.read_until(b']')
    
    # 采集CPU
    cpu_output = ssh.execute(b'display cpu-usage')
    cpu_usage = parse_cpu_usage(cpu_output)
    
    # 采集内存
    mem_output = ssh.execute(b'display memory-usage')
    mem_usage = parse_memory_usage(mem_output)
    
    # 采集接口
    intf_output = ssh.execute(b'display interface brief')
    interfaces = parse_interfaces(intf_output)
    
    ssh.close()
    
    return {
        'cpu': cpu_usage,
        'memory': mem_usage,
        'interfaces': interfaces
    }
```

**预期结果**: 
- CPU < 80%
- 内存 < 70%
- 关键接口Up状态

---

### 测试场景3：SNMP数据采集

**目标**: 通过SNMP采集实时流量

**测试步骤**:
```python
from pysnmp.hlapi import *

def get_interface_traffic(host, interface_index):
    """
    获取接口流量（字节数）
    OID: ifInOctets / ifOutOctets
    """
    # 入流量
    oid_in = f'1.3.6.1.2.1.2.2.1.10.{interface_index}'
    in_octets = snmp_get(host, oid_in)
    
    # 出流量
    oid_out = f'1.3.6.1.2.1.2.2.1.16.{interface_index}'
    out_octets = snmp_get(host, oid_out)
    
    return {
        'in': in_octets,
        'out': out_octets
    }

# 计算流量速率
traffic_1 = get_interface_traffic('10.0.0.10', 1)
time.sleep(10)
traffic_2 = get_interface_traffic('10.0.0.10', 1)

rate_in = (traffic_2['in'] - traffic_1['in']) / 10  # Bytes/s
rate_out = (traffic_2['out'] - traffic_1['out']) / 10
```

**预期结果**: 成功采集到流量数据，无SNMP超时错误

---

### 测试场景4：网络拓扑发现（NetworkX）

**目标**: 通过LLDP协议自动发现拓扑

**测试步骤**:
```python
import networkx as nx
import matplotlib.pyplot as plt

def discover_topology(seed_device):
    G = nx.Graph()
    visited = set()
    queue = [seed_device]
    
    while queue:
        device = queue.pop(0)
        if device in visited:
            continue
            
        visited.add(device)
        
        # 连接设备并获取LLDP信息
        ssh = connect_device(device)
        lldp_output = ssh.execute(b'display lldp neighbor brief')
        neighbors = parse_lldp(lldp_output)
        
        for nbr in neighbors:
            G.add_edge(device, nbr['remote_device'])
            if nbr['remote_device'] not in visited:
                queue.append(nbr['remote_device'])
        
        ssh.close()
    
    return G

# 绘制拓扑图
G = discover_topology('10.0.0.10')
nx.draw(G, with_labels=True, node_color='lightblue', 
        node_size=1500, font_size=10)
plt.savefig('network_topology.png')
```

**预期结果**: 生成完整的网络拓扑图

---

### 测试场景5：配置备份

**目标**: 自动备份所有设备配置到Git

**测试步骤**:
```python
import os
from datetime import datetime

def backup_device_config(device):
    ssh = connect_device(device['ip'])
    
    # 获取配置
    config = ssh.execute(b'display current-configuration')
    
    # 保存到文件
    backup_dir = f"./backups/{datetime.now().strftime('%Y-%m-%d')}"
    os.makedirs(backup_dir, exist_ok=True)
    
    filename = f"{backup_dir}/{device['name']}.cfg"
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(config)
    
    ssh.close()
    return filename

# 批量备份
for device in all_devices:
    backup_file = backup_device_config(device)
    print(f"已备份: {backup_file}")

# 提交到Git
os.system('git add backups/')
os.system(f'git commit -m "Config backup {datetime.now()}"')
os.system('git push')
```

**预期结果**: 所有配置文件保存在Git仓库中

---

## 📊 性能基准测试

### 测试指标

| 指标 | 小型拓扑 | 中型拓扑 | 大型拓扑 |
|------|---------|---------|---------|
| 设备数量 | 6台 | 15台 | 30台 |
| 全设备巡检时间 | <30秒 | <2分钟 | <5分钟 |
| 单设备连接时间 | <3秒 | <3秒 | <3秒 |
| 报告生成时间 | <5秒 | <10秒 | <20秒 |
| 并发连接数 | 5 | 10 | 20 |

### 优化建议

1. **使用多线程**
```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=10) as executor:
    results = executor.map(inspect_device, devices)
```

2. **使用连接池**
```python
# 保持SSH连接，避免重复连接
class SSHConnectionPool:
    def __init__(self):
        self.connections = {}
    
    def get_connection(self, host):
        if host not in self.connections:
            self.connections[host] = VisualSSH(host, ...)
        return self.connections[host]
```

3. **缓存设备信息**
```python
# 不需要每次都查询version等固定信息
cache = {
    'device1': {
        'version': 'V200R005C10',
        'last_update': '2025-10-15'
    }
}
```

---

## 🚀 快速开始指南

### Step 1: 下载拓扑文件

**eNSP拓扑文件（已准备好的）**:
```
小型拓扑: topology_small.topo
中型拓扑: topology_medium.topo
```

*（注：您需要根据上述设计自己在eNSP中搭建，或者我可以帮您生成配置脚本）*

### Step 2: 导入拓扑到eNSP

1. 打开eNSP软件
2. 文件 → 导入拓扑
3. 选择对应的.topo文件
4. 启动所有设备

### Step 3: 执行基础配置

```bash
# 使用自动化脚本批量配置（可选）
python scripts/init_devices.py --topology small
```

### Step 4: 测试巡检脚本

```bash
# 运行基础巡检
python main_refactored.py

# 查看报告
ls reports/
```

---

## 📝 总结与建议

### 推荐学习路径

1. **第1周**: 搭建方案一（小型拓扑），验证基础功能
2. **第2-3周**: 完善巡检脚本，添加报告生成
3. **第4-5周**: 升级到方案二，测试SNMP和拓扑发现
4. **第6-8周**: 挑战方案三，实现完整自动化平台

### 常见问题

**Q1: eNSP资源不够，设备启动不了？**
A: 减少设备数量或使用云平台（阿里云/华为云）的虚拟设备

**Q2: 设备配置太复杂？**
A: 使用我提供的配置模板，直接粘贴到设备

**Q3: Python脚本连接超时？**
A: 检查设备管理IP是否配置正确，SSH服务是否启用

---

## 📚 附录

### 附录A：完整设备配置模板

[查看 device_config_templates/ 目录]

### 附录B：巡检脚本示例

[查看 scripts/inspection_examples/ 目录]

### 附录C：eNSP拓扑文件

[查看 topologies/ 目录]

---

**文档版本**: v1.0  
**创建日期**: 2025-10-15  
**适用项目**: Python网络设备自动化巡检平台  
**作者**: 袁瑞

**下一步行动**: 选择一个拓扑方案，开始搭建实验环境！🚀

